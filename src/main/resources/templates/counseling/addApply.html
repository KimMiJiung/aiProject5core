<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìƒë‹´ ì‹ ì²­</title>
  <th:block th:replace="~{top}"></th:block>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>  
  <link th:href="@{/css/addApply.css}" rel="stylesheet">
</head>
<body>
  <div class="apply-container">
    <form th:object="${counseling}" th:action="@{/counseling/add}" method="post" name="applyForm">
      <input type="hidden" id="memberId" sec:authorize="isAuthenticated()" th:value="${#authentication.getPrincipal().getUsername()}">
      <header class="apply-header">
        <h2 class="apply-title">ìƒë‹´ ì‹ ì²­</h2>
        <p class="apply-subtitle">í¬ë§ ì°¨ì¢…ê³¼ êµ¬ë§¤ ê³„íšì„ ì•Œë ¤ì£¼ì‹œë©´, ìµœì ì˜ ë”œëŸ¬ì™€ ì—°ê²°í•´ ë“œë¦½ë‹ˆë‹¤.</p>
      </header>
	  <div>
		<p class="field-error text-danger" th:errors="*{vehicleId}"></p>
		<p class="field-error text-danger" th:errors="*{vehicleName}"></p>
	    <p class="field-error text-danger" th:errors="*{hopearea.sido}"></p>
	    <p class="field-error text-danger" th:errors="*{hopearea.siGunGu}"></p>
	    <p class="field-error text-danger" th:errors="*{hopearea.eupMyeonDong}"></p>
	    <p class="field-error text-danger" th:errors="*{purchasePurpose}"></p>
	    <p class="field-error text-danger" th:errors="*{otherInput}"></p>
	    <p class="field-error text-danger" th:errors="*{purchasePeriod}"></p>
	  </div>		  
      <div class="apply-content">
        <div class="accordion-item">
          <div class="accordion-header">
            <div class="accordion-header-left">
              <span class="step-badge">STEP 1</span>
              <div class="accordion-header-title">
                <div class="accordion-header-main">
                  <span class="required">ìƒë‹´ ì°¨ì¢…</span>
                </div>
                <span class="accordion-header-sub">ê´€ì‹¬ ìˆëŠ” ì°¨ëŸ‰ ëª¨ë¸ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</span>
              </div>
            </div>
            <div class="step-right">
              <span class="step-right-text stepText1">ì„ íƒ ì•ˆ í•¨</span>
              <span class="accordion-arrow">â–¼</span>
            </div>
          </div>
          <div class="accordion-content">
            <div class="tabs">
              <button type="button" class="tab-button active" data-vehicletype="ì„¸ë‹¨">ì„¸ë‹¨</button>
              <button type="button" class="tab-button" data-vehicletype="SUV">SUV</button>
              <button type="button" class="tab-button" data-vehicletype="ê²½ì°¨">ê²½ì°¨</button>
            </div>
            <div class="car-selection">
              <div th:each="vehicle : ${vehicleList}"
                   class="car-item"
                   th:classappend="${vehicle.name == selectedVehicleName} ? 'selected'"
                   th:data-vehicle-id="${vehicle.id}"
                   th:data-vehicle-name="${vehicle.name}"
                   th:data-vehicletype="${vehicle.vehicleType}">
                <img th:src="@{/images/} + ${vehicle.fileName}"
                     th:alt="${vehicle.name}" />
                <p th:text="${vehicle.name}"  th:field="*{vehicleName}"></p>
              </div>
            </div>
            <div class="selected-info">
              ì„ íƒëœ ì°¨ëŸ‰: **<span id="selectedCarDisplay" th:text="${selectedVehicleName ?: 'ì„ íƒëœ ì°¨ëŸ‰ ì—†ìŒ'}"></span>**
              <input type="hidden" name="vehicleId" id="selectedVehicleId" th:field="*{vehicleId}" />
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <div class="accordion-header">
            <div class="accordion-header-left">
              <span class="step-badge">STEP 2</span>
              <div class="accordion-header-title">
                <div class="accordion-header-main">
                  <span class="required">êµ¬ë§¤ ìƒë‹´ í¬ë§ ì§€ì—­</span>
                </div>
                <span class="accordion-header-sub">ê°€ê¹Œìš´ ì§€ì ì„ ì•ˆë‚´í•´ ë“œë¦¬ê¸° ìœ„í•´ í•„ìš”í•œ ì •ë³´ì…ë‹ˆë‹¤.</span>
              </div>
            </div>
            <div class="step-right">
              <span class="step-right-text stepText2">ì„ íƒ ì•ˆ í•¨</span>
              <span class="accordion-arrow">â–¼</span>
            </div>
          </div>
          <div class="accordion-content">
            <div class="form-row">
              <input type="hidden" name="sido" id="sidoName" th:field="*{hopearea.sido}">
              <input type="hidden" name="siGunGu" id="siGunGuName" th:field="*{hopearea.siGunGu}">
              <input type="hidden" name="eupMyeonDong" id="eupMyeonDongName" th:field="*{hopearea.eupMyeonDong}">
              <label for="sido" class="required">ì‹œ/ë„</label>
              <select class="area" name="sido" id="sido">
                <option value="">ì‹œ/ë„ ì„ íƒ</option>
              </select>

              <label for="siGunGu" class="required">ì‹œ/êµ°/êµ¬</label>
              <select class="area" name="siGunGu" id="siGunGu">
                <option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>
              </select>

              <label for="eupMyeonDong">ì/ë©´/ë™</label>
              <select class="area" name="eupMyeonDong" id="eupMyeonDong">
                <option value="">ì/ë©´/ë™ ì„ íƒ</option>
              </select>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <div class="accordion-header">
            <div class="accordion-header-left">
              <span class="step-badge">STEP 3</span>
              <div class="accordion-header-title">
                <div class="accordion-header-main">
                  <span class="required">êµ¬ë§¤ í¬ë§ ì •ë³´</span>
                </div>
                <span class="accordion-header-sub">êµ¬ì²´ì ì¸ êµ¬ë§¤ ê³„íšì„ ì•Œë ¤ì£¼ì‹œë©´ ë” ì •í™•í•œ ìƒë‹´ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
              </div>
            </div>
            <div class="step-right">
              <span class="step-right-text stepText3"></span>
              <span class="accordion-arrow">â–¼</span>
            </div>
          </div>
          <div class="accordion-content">
            <div class="accordion-description">
              ë” ë‚˜ì€ êµ¬ë§¤ ìƒë‹´ì„ ìœ„í•´ ê³ ê°ë‹˜ì˜ êµ¬ë§¤ í¬ë§ ê´€ë ¨ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
              <strong>*</strong>ê°€ í‘œì‹œëœ í•­ëª©ì€ í•„ìˆ˜ ì„ íƒ í•­ëª©ì…ë‹ˆë‹¤.
            </div>

            <div class="survey-section">
              <p class="question-title required">ì°¨ëŸ‰ êµ¬ë§¤ ëª©ì </p>
              <hr class="section-divider">
              <div class="input-group">
                <input type="checkbox" id="p1" name="purchasePurpose" value="ì¶œí‡´ê·¼ìš©">
                <label for="p1">ì¶œí‡´ê·¼ìš©</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="p2" name="purchasePurpose" value="íŒ¨ë°€ë¦¬ì¹´">
                <label for="p2">íŒ¨ë°€ë¦¬ì¹´</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="p3" name="purchasePurpose" value="ì—…ë¬´ìš©">
                <label for="p3">ì—…ë¬´ìš©</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="p4" name="purchasePurpose" value="ì„¸ì»¨ë“œì¹´">
                <label for="p4">ì„¸ì»¨ë“œì¹´</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="other" name="purchasePurpose" value="ê¸°íƒ€">
                <label for="other">ê¸°íƒ€</label>
                <input type="text" id="otherInput" name="otherInput" class="other-input"
                       placeholder="ê¸°íƒ€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”" disabled>
              </div>
            </div>

            <div class="survey-section">
              <p class="question-title required">í¬ë§ êµ¬ë§¤ ì‹œì </p>
              <hr class="section-divider">
              <div class="input-group">
                <input type="radio" id="pt1m" name="purchasePeriod" value="1ê°œì›” ì´ë‚´">
                <label for="pt1m">1ê°œì›” ì´ë‚´</label>
              </div>
              <div class="input-group">
                <input type="radio" id="pt3m" name="purchasePeriod" value="3ê°œì›” ì´ë‚´">
                <label for="pt3m">3ê°œì›” ì´ë‚´</label>
              </div>
              <div class="input-group">
                <input type="radio" id="pt6m" name="purchasePeriod" value="6ê°œì›” ì´ë‚´">
                <label for="pt6m">6ê°œì›” ì´ë‚´</label>
              </div>
              <div class="input-group">
                <input type="radio" id="ptNon" name="purchasePeriod" value="ë¯¸ì •">
                <label for="ptNon">ë¯¸ì •</label>
              </div>
            </div>
            <div class="survey-section">
              <p class="question-title">ì„ í˜¸ ì°¨ëŸ‰ ìœ í˜•</p>
              <hr class="section-divider">
              <div class="input-group">
                <input type="checkbox" id="vt1" name="vehicleType" value="ì„¸ë‹¨">
                <label for="vt1">ì„¸ë‹¨</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="vt2" name="vehicleType" value="SUV">
                <label for="vt2">SUV</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="vt3" name="vehicleType" value="ê¸°íƒ€">
                <label for="vt3">ê¸°íƒ€</label>
              </div>
            </div>
            <div class="survey-section">
              <p class="question-title">ì„ í˜¸ ì—”ì§„</p>
              <hr class="section-divider">
              <div class="input-group">
                <input type="checkbox" id="et1" name="engineType" value="ê°€ì†”ë¦°">
                <label for="et1">ê°€ì†”ë¦°</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="et2" name="engineType" value="ì „ê¸°">
                <label for="et2">ì „ê¸°</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="et3" name="engineType" value="í•˜ì´ë¸Œë¦¬ë“œ">
                <label for="et3">í•˜ì´ë¸Œë¦¬ë“œ</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="et4" name="engineType" value="ìˆ˜ì†Œ">
                <label for="et4">ìˆ˜ì†Œ</label>
              </div>
              <div class="input-group">
                <input type="checkbox" id="et5" name="engineType" value="ê³ ì„±ëŠ¥ (N)">
                <label for="et5">ê³ ì„±ëŠ¥ (N)</label>
              </div>
            </div>
            <div class="survey-section">
              <p class="question-title">í¬ë§ ì—°ë½ì¼</p>
              <hr class="section-divider">
              <input type="date" id="counselingLikeTime" name="counselingLikeTime" class="other-input"
                     placeholder="ì˜ˆ: í‰ì¼ ì˜¤í›„ 7ì‹œ ì´í›„ ì—°ë½ ë°”ëë‹ˆë‹¤.">
            </div>
            <div class="btns">
              <input type="button" value="í™•ì¸" id="btnComplete" class="btn btn-outline">
            </div>
          </div>
        </div>
        <hr class="page-divider">
        <div name="applyForm" th:action="@{/counseling/add}" method="post">
          <div class="btns">
            <input type="submit" value="êµ¬ë§¤ ì‹ ì²­ ì œì¶œ" class="btn btn-primary">
            <input type="reset" value="ì·¨ì†Œ" class="btn btn-secondary">
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- âœ… footer fragment include -->
<th:block th:replace="~{bottom}"></th:block>

</body>

<script>
    // ì•„ì½”ë””ì–¸
    let items = document.querySelectorAll(".accordion-item");

    items.forEach((item) => {
        let header = item.querySelector(".accordion-header");
        let form = document.applyForm;
        header.addEventListener("click", () => {
            let openContent = document.querySelector(".accordion-content.open");
            let sidoEl = document.querySelector("#sidoName");
            let siGunGuEl = document.querySelector("#siGunGuName");
            let eupMyeonDongEl = document.querySelector("#eupMyeonDongName");
            let sido = sidoEl.value;
            let siGunGu = siGunGuEl.value;
            let eupMyeonDong = eupMyeonDongEl.value;
            let stepText1 = document.querySelector(".stepText1");
            let stepText2 = document.querySelector(".stepText2");

            // ì—´ë ¤ ìˆëŠ” íŒ¨ë„ì´ ìˆê³ , ê·¸ê²Œ ì§€ê¸ˆ í´ë¦­í•œ ê²ƒì´ ì•„ë‹ˆë¼ë©´ ë‹«ê¸°
            if (openContent && openContent !== item.querySelector(".accordion-content")) {
                openContent.classList.remove("open");

                // Step 1 í—¤ë” ìš”ì•½ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì°¨ì¢…ì´ ì„ íƒë˜ì—ˆë‹¤ë©´)
                let selectedVehicleName = document.getElementById('selectedCarDisplay').textContent;
                stepText1.textContent = selectedVehicleName || "ì„ íƒ ì•ˆ í•¨";

                // Step 2 í—¤ë” ìš”ì•½ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                if (openContent.closest('.accordion-item').querySelector('.step-badge').textContent === 'STEP 2') {
                    let areaText = sido + '   ' + siGunGu + '  ' + eupMyeonDong;
                    stepText2.textContent = areaText.length > 0 ? areaText : "ì„ íƒ ì•ˆ í•¨";
                }

                // ë‹«íˆëŠ” íŒ¨ë„ì´ Step 3ë¼ë©´, ì…ë ¥ í•„ë“œë¥¼ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
                if (openContent.closest('.accordion-item').querySelector('.step-badge').textContent === 'STEP 3') {
                    openContent.style.display = ''; // ì…ë ¥ í•„ë“œë¥¼ ë‹¤ì‹œ ë³´ì´ê²Œ í•¨
                    openContent.closest('.accordion-item').querySelector('.purchase-summary-table-container')?.remove(); // ìš”ì•½ í…Œì´ë¸” ì œê±°
                    let stepText3 = openContent.closest('.accordion-item').querySelector(".stepText3");
                    // ìš”ì•½ í…ìŠ¤íŠ¸ ë³µêµ¬ (ì„ íƒ ì•ˆ í•¨)
                    if (stepText3 && stepText3.textContent === '') {
                        stepText3.textContent = 'ì„ íƒ ì•ˆ í•¨';
                    }
                }

                let openArrow = openContent.previousElementSibling.querySelector(".accordion-arrow");
                if (openArrow) openArrow.style.transform = "rotate(0deg)";
            }

            // í˜„ì¬ íŒ¨ë„ open/close toggle
            let content = item.querySelector(".accordion-content");
            let arrow = item.querySelector(".accordion-arrow");
            content.classList.toggle("open");

            // í™”ì‚´í‘œ íšŒì „
            if (content.classList.contains("open")) {
                arrow.style.transform = "rotate(180deg)";
                // í˜„ì¬ ì—¬ëŠ” íŒ¨ë„ì´ Step 3ë¼ë©´, ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œ ë‹¤ì‹œ í‘œì‹œ
                const isStep3 = item.querySelector('.step-badge').textContent === 'STEP 3';
                if (isStep3) {
                    content.style.display = '';
                    item.querySelector('.purchase-summary-table-container')?.remove();
                    // í—¤ë” í…ìŠ¤íŠ¸ ë³µêµ¬ (ì„ íƒ ì•ˆ í•¨)
                    let stepText3 = item.querySelector(".stepText3");
                    if (stepText3.textContent === '') {
                        stepText3.textContent = 'ì„ íƒ ì•ˆ í•¨';
                    }
                }
            } else {
                arrow.style.transform = "rotate(0deg)";
            }
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        let form = document.applyForm;
        let likeInfo = document.querySelector(".likeInfo");
        let result = document.querySelector(".result");
        let btnComplete = document.querySelector("#btnComplete");

        let stepText1 = document.querySelector(".stepText1");
        let stepText2 = document.querySelector(".stepText2");

        // --- â–¼â–¼â–¼ Step 3 ìš”ì•½ í†µí•© í•¨ìˆ˜: ë°ì´í„° ìˆ˜ì§‘ ë° ì„ì‹œ í—¤ë” ì—…ë°ì´íŠ¸ ì—­í• ë§Œ ìˆ˜í–‰ â–¼â–¼â–¼ ---
        function updateStep3HeaderSummary() {
            let form = document.applyForm;
            let purchasePurposeList = [];
            let engineTypeList = [];
            let vehicleTypeList = [];
            let otherInput = document.querySelector("#otherInput");
            let otherInputVal = otherInput.value;

            let purchasePurpose = document.querySelectorAll("[name=purchasePurpose]");
            let engineType = document.querySelectorAll("[name=engineType]");
            let vehicleType = document.querySelectorAll("[name=vehicleType]");
            let purchasePeriod = form.purchasePeriod.value;
            let counselingLikeTime = form.counselingLikeTime.value;

            // 1. êµ¬ë§¤ ëª©ì  ìˆ˜ì§‘
            purchasePurpose.forEach(v => {
                if (v.checked) {
                    if (v.value != "ê¸°íƒ€") {
                        purchasePurposeList.push(v.value);
                    } else if (otherInput.checked && otherInputVal) {
                        purchasePurposeList.push(`ê¸°íƒ€(${otherInputVal})`);
                    }
                }
            });

            // 2. ì—”ì§„ íƒ€ì… ìˆ˜ì§‘
            engineType.forEach(v => {
                if (v.checked) {
                    engineTypeList.push(v.value);
                }
            });

            // 3. ì°¨ëŸ‰ ìœ í˜• ìˆ˜ì§‘
            vehicleType.forEach(v => {
                if (v.checked) {
                    vehicleTypeList.push(v.value);
                }
            });

            let stepText3 = document.querySelector(".stepText3");
            stepText3.textContent = '';

            return {
                purchasePurposeList,
                otherInputVal,
                purchasePeriod,
                vehicleTypeList,
                engineTypeList,
                counselingLikeTime
            };
        }
        // --- â–²â–²â–² Step 3 ìš”ì•½ í†µí•© í•¨ìˆ˜ ë â–²â–²â–² ---

        // --- â–¼â–¼â–¼ Step 1 ì°¨ì¢… ì„ íƒ ê¸°ëŠ¥ JavaScript í†µí•© ë° ìˆ˜ì • â–¼â–¼â–¼ ---
        let carItems = document.querySelectorAll('.car-item');
        let tabButtons = document.querySelectorAll('.tab-button');
        let selectedCarDisplay = document.getElementById('selectedCarDisplay');
        let selectedVehicleIdInput = document.getElementById('selectedVehicleId');

        // --- 1. íƒ­ ì´ë™ ë° í•„í„°ë§ ê¸°ëŠ¥ (vehicleType ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§) ---
        function filterVehicles(vehicleType) {
            carItems.forEach(item => {
                if (item.getAttribute('data-vehicletype') === vehicleType) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                document.querySelector('.tab-button.active')?.classList.remove('active');
                this.classList.add('active');

                let vehicleType = this.getAttribute('data-vehicletype');
                filterVehicles(vehicleType);
            });
        });

        // ì´ˆê¸° ë¡œë”© ì‹œì—ë„ data-vehicletypeì„ ì‚¬ìš©í•´ í•„í„°ë§
        let initialVehicleType = document.querySelector('.tab-button.active')?.getAttribute('data-vehicletype');
        if (initialVehicleType) {
            filterVehicles(initialVehicleType);
        }

        // --- 2. ì°¨ëŸ‰ ì„ íƒ ê¸°ëŠ¥ (Step 1 í—¤ë” ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€) ---
        carItems.forEach(item => {
            item.addEventListener('click', function() {
                document.querySelector('.car-item.selected')?.classList.remove('selected');
                this.classList.add('selected');

                let vehicleId = this.getAttribute('data-vehicle-id');
                let vehicleName = this.getAttribute('data-vehicle-name');

                selectedCarDisplay.textContent = vehicleName;
                selectedVehicleIdInput.value = vehicleId;

                // *ìˆ˜ì •: ì°¨ëŸ‰ ì„ íƒ ì‹œ Step 1 í—¤ë” í…ìŠ¤íŠ¸ë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸*
                stepText1.textContent = vehicleName;
                console.log("ì„ íƒëœ ì°¨ëŸ‰ ID:", vehicleId);
            });
        });

        let initialId = selectedVehicleIdInput.value;
        // ì´ˆê¸° vehicleName ì„¤ì • (í˜ì´ì§€ ë¡œë”© ì‹œ)
        if (initialId) {
            let initialSelectedItem = document.querySelector(`.car-item[data-vehicle-id="${initialId}"]`);
            if (initialSelectedItem) {
                initialSelectedItem.classList.add('selected');
                let initialVehicleName = initialSelectedItem.getAttribute('data-vehicle-name');
                selectedCarDisplay.textContent = initialVehicleName;
                stepText1.textContent = initialVehicleName;
            }
        }

        // --- â–²â–²â–² Step 1 ì°¨ì¢… ì„ íƒ ê¸°ëŠ¥ JavaScript í†µí•© ë° ìˆ˜ì • â–²â–²â–² ---

        // Step 3 ì…ë ¥ í•„ë“œì˜ ë³€ê²½ ì‹œë§ˆë‹¤ í—¤ë” ìš”ì•½ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„)
        const step3Inputs = document.querySelectorAll(
            "[name=purchasePurpose], [name=purchasePeriod], [name=vehicleType], [name=engineType], #counselingLikeTime, #otherInput"
        );
        step3Inputs.forEach(input => {
            const eventType = (input.tagName === 'INPUT' && (input.type === 'text' || input.type === 'date')) ? 'input' : 'change';
            input.addEventListener(eventType, updateStep3HeaderSummary);
        });
        updateStep3HeaderSummary(); // ì´ˆê¸°ê°’ ì„¤ì •

        // --- Step 3 'í™•ì¸' ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ (ì£¼ìš” ìˆ˜ì • ì‚¬í•­) ---
        if (btnComplete) {
            btnComplete.addEventListener("click", () => {
                let summaryData = updateStep3HeaderSummary();

                // 1. ìœ íš¨ì„± ê²€ì‚¬
                let otherCheckbox = document.querySelector("#other");
                if (otherCheckbox.checked && (!summaryData.otherInputVal)) {
                    alert("ê¸°íƒ€ ì„ íƒ ì‹œ ë°˜ë“œì‹œ ì…ë ¥ë€ì— ì…ë ¥í•´ì£¼ì„¸ìš”");
                    return;
                }

                // 2. Step 3 í—¤ë” ìš”ì•½ í…ìŠ¤íŠ¸ ì œê±° (ì´ˆë¡ë°•ìŠ¤ ë‚´ìš© ì§€ìš°ê¸°)
                let stepText3 = document.querySelector(".stepText3");
                stepText3.textContent = '';

                // 3. Step 3 í•­ëª© ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ (ì•„ì½”ë””ì–¸ ë‚´ìš©) ì°¾ê¸°
                let step3Content = btnComplete.closest(".accordion-content");
                let step3Item = btnComplete.closest(".accordion-item");

                // 4. í‘œ í˜•ì‹ ìš”ì•½ HTML ìƒì„±
                let tableHtml = `
			      <div class="purchase-summary-table-container">
			          <style>
			              .purchase-summary-table { 
			                  width: 100%; 
			                  border-collapse: collapse; 
			                  border-top: 1px solid #c9c9c9;
			                  margin-bottom: 20px;
			              }
			              .purchase-summary-table td {
			                  padding: 18px 0; 
			                  padding-left: 20px;
			                  padding-right: 20px;
			                  font-size: 15px;
			                  line-height: 1.8;
			              }
			              
			              .purchase-summary-table tr {
			                  border-bottom: 1px solid #ededed; 
			              }
			              
			              .purchase-summary-table tbody tr:last-child {
			                  border-bottom: none;
			              }

			              .purchase-summary-table .label {
			                  width: 40%; 
			                  color: #333;
							  font-weight: 700;
			                  text-align: right;
							  font-size: 17px;
			              }
			              
			              .purchase-summary-table .value {
			                  width: 60%; 
			                  color: navy;
			                  font-weight: 700;
			                  text-align: right;
							  font-size: 17px;
			              }
			          </style>
			          <table class="purchase-summary-table">
			          <tbody>
			  `  ;

                 // í—¬í¼ í•¨ìˆ˜: ìš”ì•½ ì •ë³´ë¥¼ í…Œì´ë¸” í–‰ìœ¼ë¡œ ì¶”ê°€
                 let addRow = (label, values, otherVal = null, checkOther = false) => {
                    let displayValue = values.join(", ");

                    if (checkOther && otherVal && document.querySelector("#other").checked) {
                        displayValue += (displayValue ? ", " : "") + `${otherVal}`;
                    }

                    if (displayValue) {
                        tableHtml += `
                            <tr>
                                <td class="label" style="border-bottom: none;">${label}</td>
                                <td class="value">${displayValue}</td>
                            </tr>
                        `;
                    }
                    return displayValue;
                };

                // 1. ì°¨ëŸ‰ êµ¬ë§¤ ëª©ì 
                let purposeDisplay = addRow("ì°¨ëŸ‰ êµ¬ë§¤ ëª©ì ", summaryData.purchasePurposeList.filter(p => !p.startsWith('ê¸°íƒ€')), summaryData.otherInputVal, true);
                // 2. í¬ë§ êµ¬ë§¤ ì‹œì 
                let periodDisplay = addRow("í¬ë§ êµ¬ë§¤ ì‹œì ", [summaryData.purchasePeriod]);
                // 3. ì„ í˜¸ ì°¨ëŸ‰ ìœ í˜•
                let vehicleDisplay = addRow("ì„ í˜¸ ì°¨ëŸ‰ ìœ í˜•", summaryData.vehicleTypeList);
                // 4. ì„ í˜¸ ì—”ì§„
                let engineDisplay = addRow("ì„ í˜¸ ì—”ì§„", summaryData.engineTypeList);
                // 5. í¬ë§ ì—°ë½ ì‹œê°„
                let timeDisplay = addRow("í¬ë§ ì—°ë½ ì‹œê°„", [summaryData.counselingLikeTime]);
                tableHtml += `</tbody></table></div>`;

                // 5. ìš”ì•½ í…Œì´ë¸” ì‚½ì…
                step3Item.querySelector('.purchase-summary-table-container')?.remove();
                if (step3Content) {
                    step3Content.style.display = 'none'; // ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸°
                    // ìš”ì•½ í…Œì´ë¸”ì„ ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œ ë°”ë¡œ ì•ì— ì‚½ì…
                    step3Content.insertAdjacentHTML('beforebegin', tableHtml);
                }
            });
        }
        // --- Step 3 'í™•ì¸' ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ë ---

        let sidoEl = document.querySelector("#sidoName");
        let siGunGuEl = document.querySelector("#siGunGuName");
        let eupMyeonDongEl = document.querySelector("#eupMyeonDongName");
        let sidoTxt = sidoEl.value;
        let siGunGuTxt = siGunGuEl.value;
        let eupMyeonDongTxt = eupMyeonDongEl.value;

        // Step 2 ì§€ì—­ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ í—¤ë” ì—…ë°ì´íŠ¸
        document.querySelectorAll('#sidoName, #siGunGuName, #eupMyeonDongName').forEach(select => {
            select.addEventListener('change', () => {
                let sidoSel = document.querySelector("#sidoName");
                let siGunGuSel = document.querySelector("#siGunGuName");
                let eupMyeonDongSel = document.querySelector("#eupMyeonDongName");
                console.log(sidoSel.value);

                // ì„ íƒëœ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. "ì‹œ/ë„ ì„ íƒ"ê³¼ ê°™ì€ ê¸°ë³¸ ì˜µì…˜ì€ ë¹ˆ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                let sidoTxt = sidoSel.selectedIndex > 0 ? sidoSel.options[sidoSel.selectedIndex].textContent : '';
                let siGunGuTxt = siGunGuSel.selectedIndex > 0 ? siGunGuSel.options[siGunGuSel.selectedIndex].textContent : '';
                let eupMyeonDongTxt = eupMyeonDongSel.selectedIndex > 0 ? eupMyeonDongSel.options[eupMyeonDongSel.selectedIndex].textContent : '';

                let areaText = `${sidoSel.value} ${siGunGuSel.value} ${eupMyeonDongSel.value}`.trim();

                // Step 2 í—¤ë” ì—…ë°ì´íŠ¸
                stepText2.textContent = areaText.length > 0 ? areaText : "ì„ íƒ ì•ˆ í•¨";
            });
        });

        // ê¸°íƒ€(other) ì…ë ¥ í•„ë“œ í™œì„±í™” ë¡œì§ (jQuery ì™¸ë¶€ ë¡œì§ê³¼ í†µí•©)
        $("#other").on("change", function () {
            let otherInput = $("#otherInput");
            if ($(this).is(":checked")) {
                otherInput.removeAttr("disabled");
                otherInput.focus();
            } else {
                otherInput.attr("disabled", "disabled");
                otherInput.val("");
            }
        });
    });



    document.addEventListener("DOMContentLoaded", () => {

        /*
            ë„ë©”ì¸ ë³€ê²½ (25-11-13)
            sgis.lostat.go.kr -> sgis.mods.go.kr
        */
        // í† í°ê¸°ê°„: ~ 2025-12-30ì¼
        let CONSUMER_KEY = "38c49af2afd14150a521";        // ğŸ”¹ SGIS ë°œê¸‰
        let CONSUMER_SECRET = "f1250051cce248a68197";     // ğŸ”¹ SGIS ë°œê¸‰

        // 1) AccessToken ë°œê¸‰
        async function getToken() {
            let url = `https://sgisapi.mods.go.kr/OpenAPI3/auth/authentication.json?consumer_key=${CONSUMER_KEY}&consumer_secret=${CONSUMER_SECRET}`;
            let res = await fetch(url);
            let json = await res.json();
            return json.result.accessToken;
        }

        // 2) ì‹œ/ë„ ì¡°íšŒ (ìƒìœ„ ë‹¨ê³„)
        async function loadSido(token) {
            let url = `https://sgisapi.mods.go.kr/OpenAPI3/addr/stage.json?accessToken=${token}`;
            let res = await fetch(url);
            let json = await res.json();

            let sidoSel = document.getElementById("sido");

            json.result.forEach(item => {
                let op = document.createElement("option");
                op.value = item.cd;
                op.textContent = item.addr_name;
                sidoSel.appendChild(op);
            });

            // ì‹œë„ ë³€ê²½ ì‹œ ì‹œêµ°êµ¬ ë¡œë“œ
            sidoSel.addEventListener("change", (e) => {
                let options = e.currentTarget.options;
                let idx = e.currentTarget.options.selectedIndex;
                console.log("ì‹œë„ê°’: " + options[idx].textContent);
                $("#sidoName").val(options[idx].textContent);
                loadSigungu(token, sidoSel.value);
            });
        }

        // 3) ì‹œêµ°êµ¬ ì¡°íšŒ
        async function loadSigungu(token, sidoCode) {
            let url = `https://sgisapi.mods.go.kr/OpenAPI3/addr/stage.json?accessToken=${token}&cd=${sidoCode}`;
            let res = await fetch(url);
            let json = await res.json();

            let sgSel = document.getElementById("siGunGu");
            sgSel.innerHTML = `<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>`;

            let emdSel = document.getElementById("eupMyeonDong");
            emdSel.innerHTML = `<option value="">ì/ë©´/ë™ ì„ íƒ</option>`;

            json.result.forEach(item => {
                let op = document.createElement("option");
                op.value = item.cd;
                op.textContent = item.addr_name;
                sgSel.appendChild(op);
            });
        }

        // 4) ìë©´ë™ ì¡°íšŒ
        async function loadEmd(token, sigunguCode) {
            let url = `https://sgisapi.mods.go.kr/OpenAPI3/addr/stage.json?accessToken=${token}&cd=${sigunguCode}`;
            let res = await fetch(url);
            let json = await res.json();

            let emdSel = document.getElementById("eupMyeonDong");
            emdSel.innerHTML = `<option value="">ì/ë©´/ë™ ì„ íƒ</option>`;

            json.result.forEach(item => {
                let op = document.createElement("option");
                op.value = item.cd;
                op.textContent = item.addr_name;
                emdSel.appendChild(op);
            });
        }

        // 5) ì‹œêµ°êµ¬ ë³€ê²½ ì‹œ í˜¸ì¶œë  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜
        function changeSigungu(token) {
            let sgSel = document.getElementById("siGunGu");

            sgSel.addEventListener("change", (e) => {
                let options = e.currentTarget.options;
                let idx = e.currentTarget.options.selectedIndex;
                // í…ìŠ¤íŠ¸ ì¶œë ¥
                console.log("ì‹œêµ°êµ¬ê°’: " + options[idx].textContent);
                $("#siGunGuName").val(options[idx].textContent);
                // ìë©´ë™ ë¡œë“œ
                loadEmd(token, sgSel.value);
            });
        }

        // 6) ìë©´ë™ ë³€ê²½ ì‹œ í˜¸ì¶œë  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜
        function changeEmd() {
            let emdSel = document.getElementById("eupMyeonDong");

            emdSel.addEventListener("change", (e) => {
                let options = e.currentTarget.options;
                let idx = e.currentTarget.options.selectedIndex;
                // í…ìŠ¤íŠ¸ ì¶œë ¥
                console.log("ìë©´ë™ê°’: " + options[idx].textContent);
                $("#eupMyeonDongName").val(options[idx].textContent);
            });
        }

        // ì´ˆê¸° ì‹¤í–‰
        (async function() {
            let token = await getToken();   // 1) í† í° ë°œê¸‰
            loadSido(token);                // 2) ì‹œë„ ë¡œë“œ
            changeSigungu(token);           // 5) ì‹œêµ°êµ¬ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            changeEmd();                    // 6) ìë©´ë™ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        })();
    });

    window.onload = function() {
        let memberIdElement = document.getElementById('memberId');

        if (!memberIdElement) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
        } else {
            let memberId = memberIdElement.value;
            console.log('ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID:', memberId);
        }
    };
</script>
</html>
