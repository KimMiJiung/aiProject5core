<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <th:block th:replace="~{top}"></th:block>
  <title>ê³ ê° ìƒë‹´ì‹ ì²­ ëª©ë¡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"rel="stylesheet"/>
  <style>
    .main-con {
		max-width: 100%; 
	}

	/* ìƒë‹¨ */
	.applyListHeader {
		margin-top: -40px;
		margin-bottom: 50px;
		padding: 20px;
		text-align: center;
		background-color: #f8f8f8;
	}
	.applyListHeader > h1 {
		margin-top: 25px;
		font-size: 40px;
		font-weight: bold;
	}
	.applyListHeader > p {
		margin: 50px 0 50px 0;
		font-size: 0.9em;
	}
	
	.contents {
		max-width: 1500px;
		margin: 0 auto;
	}
	
	/* ================================================= */
	/* â— ë¦¬ìŠ¤íŠ¸ì™€ ì±—ë´‡ì„ ë‚˜ë€íˆ ë°°ì¹˜í•˜ê¸° ìœ„í•œ Flexbox ì„¤ì • */
	/* ================================================= */
	.main-content-flex {
		display: flex;
		gap: 20px; /* ë¦¬ìŠ¤íŠ¸ì™€ ì±—ë´‡ ì‚¬ì´ ê°„ê²© */
	}
	
	.list-area {
		flex: 0 0 70%; /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­: 65% ë„ˆë¹„ ê³ ì • */
		max-width: 70%;
	}
	
	.chatbot-area {
		flex: 0 0 30%; /* ì±—ë´‡ ì˜ì—­: 35% ë„ˆë¹„ ê³ ì • */
		max-width: 30%;
		/* ì±—ë´‡ ì„¹ì…˜ì€ ëª©ë¡ ì„¹ì…˜ê³¼ ë™ì¼í•œ ë†’ì´ë¡œ ì‹œì‘í•˜ë„ë¡ ë§ˆì§„ ì¡°ì • */
		margin-top: 0; 
	}
	
	/* í™”ë©´ì´ ì‘ì•„ì§€ë©´ ë‹¤ì‹œ ì„¸ë¡œë¡œ ìŒ“ì´ë„ë¡ ë¯¸ë””ì–´ ì¿¼ë¦¬ ì¶”ê°€ (ì„ íƒ ì‚¬í•­) */
	@media (max-width: 1200px) {
	    .main-content-flex {
	        flex-direction: column;
	    }
	    .list-area, .chatbot-area {
	        flex: 1 1 100%;
	        max-width: 100%;
	    }
	}
	
	/* í‘œ */
	.table-responsive {
		height: 525px;	
	}
	
    .table thead th {
      vertical-align: middle;
      text-align: center;
	  background-color: navy;
	  color: #fff;
	  font-size: 0.89em;
    }
    .table tbody td {
      vertical-align: middle;
	  font-size: 0.89em;
    }
    .table tbody tr:hover {
      background-color: #e9f0ff;
    }
    .text-truncate {
      max-width: 230px;
    }
	
	/* ìƒë‹´ ìƒíƒœ + ë²„íŠ¼ ì •ë ¬/ìŠ¤íƒ€ì¼ */
	.status-cell {
	  white-space: nowrap;
	  text-align: center;
	}

	.action-cell {
	  white-space: nowrap;
	  text-align: center; /* ë²„íŠ¼ ê·¸ë£¹ ì¤‘ì•™ ì •ë ¬ */
	}
	
	.action-cell .btn-group {
	  display: flex;
	  gap: 0.5rem; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
	  justify-content: center;
	}

	.status-cell .badge.status-badge {
	  width: 100px;
	  height: 30px;
	  font-size: 0.8rem;
	  padding: 7px;
	}
	
	.action-cell .btn-sm {
	  padding: 0.18rem 0.55rem;
	  font-size: 0.8rem;
	  line-height: 1.1;
	  font-weight: bold;
	  padding: 7px;
	}

	.btn-cancel {
		height: 30px;
		border: 1px solid red;
		color: #555;
	}
	
	.btn-cancel:hover {
		border: 1px solid red;
		background-color: red;
		color: #fff;
	}
	
	.btn-edit {
		height: 30px;
		border: 1px solid navy;
		color: #555;
	}
	
	.btn-edit:hover {
		border: 1px solid navy;
		background-color: navy;
		color: #fff;
	}
	
	/* ì·¨ì†Œë¨ ìƒíƒœì¼ ë•Œ ë°°ì§€ ìƒ‰ìƒ */
	.status-cell .badge.bg-secondary {
	  background-color: #6c757d !important;
	}
	/* ëª©ë¡, ì—‘ì…€ ë‹¤ìš´ ë²„íŠ¼ */
	.li-btn {
		color: white;
		background-color: navy;
		border: 1px solid dimgray;
		font-weight: bold;
		font-size: 0.89em;
	}
	.li-btn:hover {
		background-color: white;
		color: navy;
		border: 1px solid dimgray;
	}
	
	.ex-btn {
		margin-left: 5px;
		color: gray;
		border: 1px solid dimgray;
		font-weight: bold;
		font-size: 0.89em;
	}
	
	.ex-btn:hover {
		background-color: green;
		color: white;
		border: 1px solid dimgray;
	}
	
	/*ìƒë‹´ ì§„í–‰ì¤‘ ìˆ˜ì •,ì·¨ì†Œ ë²„íŠ¼ ë¹„í™œì„±í™”*/
	.disabled-link {
	  pointer-events: none;  /* í´ë¦­ ë§‰ê¸° */
	  opacity: 0.5;          /* ë¹„í™œì„±í™”ì²˜ëŸ¼ ë³´ì´ê²Œ */
	  cursor: not-allowed;
	}	
	
	/* í…Œì´ë¸” ì…€ í¬ê¸° ì¡°ì • */
	/* ì±—ë´‡ì´ ì˜†ì— ìˆì„ ë•ŒëŠ” ë¦¬ìŠ¤íŠ¸ ë„ˆë¹„ê°€ ì¢ì•„ì§€ë¯€ë¡œ ë„ˆë¹„ ë¹„ìœ¨ ì¡°ì • */
	.list-area .table thead th:nth-child(1) { width: 2%; } /* ì²´í¬ë°•ìŠ¤ */
	.list-area .table thead th:nth-child(2) { width: 3%; } /* ê³ ê°ID */
	.list-area .table thead th:nth-child(3) { width: 16%; } /* ë‹´ë‹¹ë”œëŸ¬ */
	.list-area .table thead th:nth-child(4) { width: 10%; } /* ì˜ˆì•½ì‹œê°„ */
	.list-area .table thead th:nth-child(5) { width: 14%; } /* ë“±ë¡ì¼ */
	.list-area .table thead th:nth-child(6) { width: 17%; } /* ì„ íƒì°¨ëŸ‰ */
	.list-area .table thead th:nth-child(7) { width: 12%; } /* í¬ë§êµ¬ë§¤ì‹œì  */
	.list-area .table thead th:nth-child(8) { width: 10%; } /* ìƒë‹´ìƒíƒœ */
	.list-area .table thead th:nth-child(9) { width: 8%; } /* ë²„íŠ¼ ê·¸ë£¹ */

	/* í˜ì´ì§€ ë²„íŠ¼ */
	.page-link {
		font-weight: bold;
	}
	
	.pagination .page-item .page-link {
	    background-color: #f0f0f0; /* ì—°í•œ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ ì˜ˆì‹œ */
	    border-color: #777;        /* í…Œë‘ë¦¬ ìƒ‰ìƒë„ ë³€ê²½ ê°€ëŠ¥ */
	    color: #333;               /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ (ì„ íƒ ì‚¬í•­) */
	}
	/* í™œì„±í™”ëœ í˜ì´ì§€ ë§í¬ì˜ ë°°ê²½ìƒ‰ ë³€ê²½ */
	.pagination .page-item.active .page-link {
	    background-color: navy; /* ğŸ‘ˆ ì§„í•œ ë‚¨ìƒ‰ìœ¼ë¡œ ë³€ê²½ ì˜ˆì‹œ */
	    border-color: navy;     /* í…Œë‘ë¦¬ë„ ê°™ì€ ìƒ‰ìœ¼ë¡œ */
	    color: white;           /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ í°ìƒ‰ìœ¼ë¡œ ìœ ì§€ */
	}
	/* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½ */
	.pagination .page-item .page-link:hover {
	    background-color: lightsteelblue;
		border-color: #111;
	}
	
	/*AI ì‹¤ì‹œê°„ ìƒë‹´ ì±—ë´‡ */
	.card {
		margin-top: 45px;
	}
	.card-header {
		background-color: navy;
		height: 37px;
	}
	.ai-title {
		font-size: 0.9em; 
		font-weight: bold;
		color: #fff;
	}
	.card-body {
		height: 490px;
	}
	
  </style>
</head>
<body>
  <div class="container main-con">
	<div class="applyListHeader">
      <h1>ê³ ê° ìƒë‹´ì‹ ì²­ ëª©ë¡</h1>
      <p>ì•„ë˜ì—ì„œ ì‹ ì²­ ë‚´ì—­ì„ í™•ì¸í•˜ê³  ìƒíƒœë³„ í•„í„°ë‚˜ í‚¤ì›Œë“œ ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    </div>

	<div class="contents">
	    
	    <div class="main-content-flex">
	    
	    <div class="list-area">
	    
		    <section class="d-flex flex-wrap justify-content-between align-items-center mb-3">
		      <div class="d-flex gap-2">
				<input type="hidden" id="memberId" th:value="${#authentication.getPrincipal().getUsername()}">
		        <select class="form-select form-select-sm" id="statusFilter"  aria-label="ìƒë‹´ ìƒíƒœ í•„í„°">
		          <option th:selected="${statusFilter == null or statusFilter == 'ì „ì²´ ìƒíƒœ'}">ì „ì²´ ìƒíƒœ</option>
		          <option th:selected="${statusFilter == 'ìƒë‹´ëŒ€ê¸°'}">ìƒë‹´ëŒ€ê¸°</option>
		          <option th:selected="${statusFilter == 'ìƒë‹´ì§„í–‰ì¤‘'}">ìƒë‹´ì§„í–‰ì¤‘</option>
		          <option th:selected="${statusFilter == 'ìƒë‹´ì·¨ì†Œ'}">ìƒë‹´ì·¨ì†Œ</option>
		          <option th:selected="${statusFilter == 'ìƒë‹´ì™„ë£Œ'}">ìƒë‹´ì™„ë£Œ</option>
				  <option th:selected="${statusFilter == 'êµ¬ë§¤ì™„ë£Œ'}">êµ¬ë§¤ì™„ë£Œ</option>
		        </select>
		        <select
		          class="form-select form-select-sm" id="sortFilter" style="width: 140px" aria-label="ì •ë ¬ ê¸°ì¤€ ì„ íƒ">
		          <option th:selected="${sortFilter == null or sortFilter == 'ë“±ë¡ì¼ ìµœì‹ ìˆœ'}">ë“±ë¡ì¼ ìµœì‹ ìˆœ</option>
		          <option th:selected="${sortFilter == 'ë“±ë¡ì¼ ì˜¤ë˜ëœìˆœ'}">ë“±ë¡ì¼ ì˜¤ë˜ëœìˆœ</option>
		        </select>
		      </div>
			
			  <div class="d-flex gap-2 mt-2 mt-sm-0">
		        <input type="hidden" id="searchInput" class="form-control form-control-sm" placeholder="ê³ ê°ID ë˜ëŠ” ì—°ë½ì²˜ ê²€ìƒ‰" aria-label="ê³ ê°ID ë˜ëŠ” ì—°ë½ì²˜ ê²€ìƒ‰" th:value="${keyword}"/>
		      </div>
		    </section>
		
		    <section class="table-responsive shadow-sm bg-white rounded">
		      <table class="table table-striped table-hover align-middle">
		        <thead class="table-light">
		          <tr>
		            <th class="text-center">
		              <input type="checkbox" id="selectAll" class="form-check-input" aria-label="ì „ì²´ ì„ íƒ"/>
		            </th>
		            <th class="text-center">ID</th>
		            <th class="text-center">ë‹´ë‹¹ë”œëŸ¬</th>
		            <th class="text-center">ì˜ˆì•½ì‹œê°„</th>
		            <th class="text-center">ë“±ë¡ì¼</th>
		            <th class="text-center">ì„ íƒì°¨ëŸ‰</th>
					<th class="text-center">í¬ë§êµ¬ë§¤ì‹œì </th>
				    <th class="text-center">ìƒë‹´ìƒíƒœ</th>
					<th class="text-center">ê´€ë¦¬</th>
		          </tr>
		        </thead>
		        <tbody id="tableBody">
					<tr th:each="apply, loop : ${applyList}" 
									th:data-id="${apply.id}" 
									th:onclick="|location.href='@{/counseling/detail/{id}(id=${apply.id})}'|" 
									style="cursor: pointer;">	
						
		
						<td class="text-center">
							<input type="checkbox" class="form-check-input rowCheckbox"
								   onclick="event.stopPropagation();" />
						</td>
						<td class="text-center" th:text="${apply.customer.member.id}"></td>
						<td class="text-center" th:if="${apply.dealer != null}" th:text="${apply.dealer.member.name} + ' (' + ${apply.dealer.member.phone} + ')'">ë¯¸ì •</dd>
						<td class="text-center" th:unless="${apply.dealer != null}">ë”œëŸ¬/ë°°ì • ëŒ€ê¸°</td>
						<td class="text-center" th:text="${apply.counselingLikeTime}"></td>
						<td class="text-center" th:text="${#temporals.format(apply.createDate, 'yyyy-MM-dd HH:mm')}"></td>
						
						<td class="text-center">
						  <a th:href="@{|/vehicles/vehicle/detail/${apply.vehicleId}|}" 
						     th:text="${apply.vehicleName}" 
						     class="fw-semibold" 
						     style="text-decoration: none; color: navy;"
						     onclick="event.stopPropagation();"
		                     title="ì„ íƒ ëª¨ë¸ ìƒì„¸ ë³´ê¸°">
						    ì°¨ëŸ‰ëª¨ë¸ëª…
						  </a>
						</td>
						
						<td class="status-cell">
							<span th:text="${apply.purchasePeriod}"></span>
						</td>
						
						<td class="status-cell">
						  <span th:classappend="${apply.status == 'ìƒë‹´ì·¨ì†Œ'} ? 'bg-secondary' : 
						                           (apply.status == 'êµ¬ë§¤ì™„ë£Œ' ? 'bg-success text-white' : 
						                           (apply.status == 'ìƒë‹´ì§„í–‰ì¤‘' ? 'bg-info text-white' : 'bg-warning text-dark'))"
						        class="badge status-badge" th:text="${apply.status}"></span>
						</td>
						
						<td class="action-cell">
						  <div class="btn-group" onclick="event.stopPropagation();">
							<a th:href="@{/counseling/applyList/cencel/{id}(id=${apply.id})}"
							   class="btn btn-sm btn-cancel"
							   aria-label="ìƒë‹´ ì·¨ì†Œ"
							   onclick="event.stopPropagation();"
							   th:classappend="${(apply.status == 'ìƒë‹´ì§„í–‰ì¤‘' || apply.status == 'ìƒë‹´ì·¨ì†Œ' || apply.status == 'êµ¬ë§¤ì™„ë£Œ')} ? ' disabled-link'">
							   ì·¨ì†Œ
							</a>					
							<a th:href="@{/counseling/detail/{id}(id=${apply.id})}" 
							   class="btn btn-sm btn-edit"
							   aria-label="ìƒë‹´ ìˆ˜ì •"
							   th:classappend="${(apply.status == 'ìƒë‹´ì§„í–‰ì¤‘' || apply.status == 'ìƒë‹´ì·¨ì†Œ' || apply.status == 'êµ¬ë§¤ì™„ë£Œ')} ? ' disabled-link'">
							   ìˆ˜ì •
							</a>
						  </div>
						</td>
					</tr>
					<tr th:if="${applyList == null or #lists.isEmpty(applyList)}">
						<td colspan="9" class="text-center text-muted py-4">ì¡°íšŒëœ ìƒë‹´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
					</tr>
		        </tbody>
		      </table>
		    </section>
		
			<section class="d-flex justify-content-end align-items-center mt-3"> 
			    <div class="mb-2 mb-sm-0">
					<a th:href="@{/counseling/addApply}" class="btn btn-outline li-btn">
					  êµ¬ë§¤ìƒë‹´ì‹ ì²­
					</a>
			        <button id="btnExcelDownload" class="btn btn-outline-secondary ex-btn" aria-label="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ">
			          ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
			        </button>
			    </div>
			</section>
		
			<section class="d-flex justify-content-center mt-3 mb-5">
			    <nav th:if="${counselingPage.totalPages > 1}" aria-label="êµ¬ë§¤ì‹ ì²­ í˜ì´ì§€">
			        <ul class="pagination pagination-sm mb-0">
			            
						<!-- ì´ì „ ë²„íŠ¼ -->
						<li class="page-item" th:classappend="${counselingPage.first} ? 'disabled'">
						    <a class="page-link"
						       th:href="${counselingPage.first} ? '#' : 
						                @{/counseling/applyList/{memberId}(
						                    memberId=${#authentication.getPrincipal().getUsername()},
						                    page=${counselingPage.number - 1},
						                    statusFilter=${statusFilter},
						                    sortFilter=${sortFilter},
						                    keyword=${keyword})}"
						       tabindex="-1"
						       aria-disabled="${counselingPage.first}">ì´ì „</a>
						</li>

						<!-- í˜ì´ì§€ ë²ˆí˜¸ -->
						<li th:each="i : ${#numbers.sequence(0, counselingPage.totalPages - 1)}"
						    th:class="${i == counselingPage.number} ? 'page-item active' : 'page-item'">
						    <a class="page-link"
						       th:text="${i + 1}"
						       th:href="@{/counseling/applyList/{memberId}(
						            memberId=${#authentication.getPrincipal().getUsername()},
						            page=${i},
						            statusFilter=${statusFilter},
						            sortFilter=${sortFilter},
						            keyword=${keyword})}"></a>
						</li>

						<!-- ë‹¤ìŒ ë²„íŠ¼ -->
						<li class="page-item" th:classappend="${counselingPage.last} ? 'disabled'">
						    <a class="page-link"
						       th:href="${counselingPage.last} ? '#' : 
						                @{/counseling/applyList/{memberId}(
						                    memberId=${#authentication.getPrincipal().getUsername()},
						                    page=${counselingPage.number + 1},
						                    statusFilter=${statusFilter},
						                    sortFilter=${sortFilter},
						                    keyword=${keyword})}"
						       aria-disabled="${counselingPage.last}">ë‹¤ìŒ</a>
						</li>
						
			        </ul>
			    </nav>
			</section>			
		</div> 
		<div class="chatbot-area">
			<div class="card shadow-sm mb-5">
				<div class="card-header">
					<h5 class="mb-0 ai-title">AI ì‹¤ì‹œê°„ ìƒë‹´ ì±—ë´‡</h5>
				</div>
				<div class="card-body p-0">
					<iframe
						th:src="@{|http://localhost:8504/5core|}"
						style="width: 100%; height: 490px; border: none; border-radius: 0 0 8px 8px; overflow: hidden;">
					</iframe>
				</div>
			</div>
		</div>
		</div> </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ====== ìš”ì†Œ ì„ íƒ ====== */
    let selectAllCheckbox = document.getElementById('selectAll');
    let rowCheckboxes = () => document.querySelectorAll('input.rowCheckbox');
    let statusFilter = document.getElementById('statusFilter');
    let sortFilter = document.getElementById('sortFilter');
    let searchInput = document.getElementById('searchInput');
    let searchButton = document.getElementById('searchBtn');
    let tableBody = document.getElementById('tableBody');
    let btnExcelDownload = document.getElementById('btnExcelDownload');

    function buildQueryString(page = 0) {
		let status = statusFilter.value;
		let sort = sortFilter.value;
		let keyword = searchInput.value.trim();
        
		let params = new URLSearchParams();
        params.append('page', page);
        params.append('statusFilter', status); 
        params.append('sortFilter', sort);
        if (keyword !== '') params.append('keyword', keyword);		
        
        return params.toString();
    }
	
	function applyFiltersAndSorting() {
		let memberId = document.getElementById("memberId").value;
		window.location.href = `/5core/counseling/applyList/${memberId}?${buildQueryString(0)}`;
	}
	
	statusFilter.addEventListener('change', applyFiltersAndSorting);
    
    // ê°œë³„ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ ë°©ì§€ ë¡œì§ ë° ì•¡ì…˜ ì²˜ë¦¬
    function handleActionClick(event) {
	  let btn = event.target.closest('button');
	  if (!btn || (!btn.classList.contains('btn-cancel') && !btn.classList.contains('btn-delete'))) return;
	  
	  let row = btn.closest('tr');
	  let counselingId = row.dataset.id;
	  let customerId = row.cells[1].textContent.trim();
	  let vehicleName = row.cells[5].querySelector('a')?.textContent.trim() ?? 'N/A';
	  
	  // ì´ë²¤íŠ¸ ë²„ë¸”ë§ì„ ë§‰ì•„ <tr> í´ë¦­ì— ì˜í•œ ìƒì„¸ í˜ì´ì§€ ì´ë™ì„ ë°©ì§€
	  event.stopPropagation();
	  
	  if (!counselingId) {
		  alert('ìƒë‹´ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
		  return;
	  }

	  if (btn.classList.contains('btn-cancel')) {
	    handleCancel(btn, counselingId, customerId, vehicleName);
	  } else if (btn.classList.contains('btn-delete')) {
		handleDelete(row, counselingId, customerId, vehicleName);
	  }
    }


    /* ====== ë©”ì¸ ê¸°ëŠ¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€, ì„œë²„ ìš”ì²­ í•„ìš” ë¶€ë¶„ë§Œ ìˆ˜ì •) ====== */
    
    // ì „ì²´ ì„ íƒ, ê°œë³„ ì„ íƒ ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
    function handleSelectAllChange() {
      let checked = selectAllCheckbox.checked;
      rowCheckboxes().forEach((cb) => {
        cb.checked = checked;
      });
    }

    // ì„ íƒëœ í–‰ ì‚­ì œ (í”„ë¡ íŠ¸ì—”ë“œ ì„ì‹œ)
    function handleDeleteSelected() {
      let checkedBoxes = Array.from(rowCheckboxes()).filter((cb) => cb.checked);

      if (checkedBoxes.length === 0) {
        alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (!confirm(`${checkedBoxes.length}ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      checkedBoxes.forEach((cb) => {
        let row = cb.closest('tr');
        if (row) {
			// **TODO**: ì—¬ê¸°ì„œ ì‹¤ì œ ì‚­ì œ API í˜¸ì¶œì´ í•„ìš”í•©ë‹ˆë‹¤.
			row.remove();
		}
      });

      selectAllCheckbox.checked = false;
	  // ì‚­ì œ í›„ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•  í•„ìš”ê°€ ìˆì„ ê²½ìš°
	  // window.location.reload(); 
    }
	
    // í…Œì´ë¸”ì„ CSVë¡œ ë³€í™˜ (ì„œë²„ì—ì„œ ë°›ì€ í˜„ì¬ í˜ì´ì§€ ë°ì´í„°ë§Œ ë³€í™˜)
	// ì„ íƒëœ í–‰ë§Œ CSVë¡œ ë³€í™˜
	function tableToCSVWithSelection() {
	  let rows = [];

	  let headers = [];
	  document.querySelectorAll('.list-area table thead th').forEach((th, idx) => {
	    // ì²´í¬ë°•ìŠ¤ ì—´(0)ê³¼ ê´€ë¦¬ ì—´(ë§ˆì§€ë§‰)ì€ ì œì™¸
	    if (idx === 0 || idx === document.querySelectorAll('.list-area table thead th').length - 1) return; 
	    let text = th.textContent.trim();
	    if (text !== '') headers.push(`"${text}"`);
	  });
	  rows.push(headers.join(','));

	  // **ë³€ê²½: ì„ íƒëœ ì²´í¬ë°•ìŠ¤ë§Œ í•„í„°ë§**
	  let checkedBoxes = Array.from(rowCheckboxes()).filter((cb) => cb.checked);
	  
	  checkedBoxes.forEach((cb) => {
	    let tr = cb.closest('tr');
	    if (!tr) return;

	    let data = [];
	    tr.querySelectorAll('td').forEach((td, idx) => {
	      // ì²´í¬ë°•ìŠ¤ ì—´(0)ê³¼ ê´€ë¦¬ ì—´(ë§ˆì§€ë§‰)ì€ ì œì™¸
	      if (idx === 0 || idx === tr.querySelectorAll('td').length - 1) return;

	      if (idx === 8) { // 9ë²ˆì§¸ ì»¬ëŸ¼ (ì¸ë±ìŠ¤ 8)
	        let badge = td.querySelector('.status-badge');
	        let text = badge ? badge.textContent.trim() : td.textContent.trim();
	        data.push(`"${text.replace(/"/g, '""')}"`);
	        return;
	      }
	      
	      // ì„ íƒ ì°¨ëŸ‰ ì…€(ì¸ë±ìŠ¤ 5)ì˜ ê²½ìš° ë§í¬ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©
	      if (idx === 5) {
	         let link = td.querySelector('a');
	         let text = link ? link.textContent.trim() : td.textContent.trim();
	         data.push(`"${text.replace(/"/g, '""')}"`);
	         return;
	      }

	      // í¬ë§êµ¬ë§¤ì‹œì  ì…€ (ì¸ë±ìŠ¤ 6)
	      if (idx === 6) {
	         let text = td.textContent.trim();
	         data.push(`"${text.replace(/"/g, '""')}"`);
	         return;
	      }


	      let text = td.textContent.trim().replace(/"/g, '""');
	      data.push(`"${text}"`);
	    });
	    if (data.length) rows.push(data.join(','));
	  });

	  return rows.join('\n');
	}


    // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    function downloadCSV(csv, filename) {
      let BOM = '\uFEFF';
      let blob = new Blob([BOM + csv], {
        type: 'text/csv;charset=utf-8;',
      });
      let url = URL.createObjectURL(blob);

      let link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.style.display = 'none';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

	// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë™ì‘ (ì„ íƒëœ í–‰ë§Œ ë‹¤ìš´ë¡œë“œ)
	function handleExcelDownload() {
	  let checkedBoxes = Array.from(rowCheckboxes()).filter((cb) => cb.checked);
	  
	  // **ë³€ê²½: ì²´í¬ë°•ìŠ¤ ì„ íƒ í•„ìˆ˜**
	  if (checkedBoxes.length === 0) {
	    alert('ë‹¤ìš´ë¡œë“œí•  ìƒë‹´ë¦¬ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
	    return;
	  }
	  
	  if (!confirm(`ì„ íƒëœ ${checkedBoxes.length}ê±´ì˜ ë°ì´í„°ë¥¼ CSV(ì—‘ì…€)ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì—‘ì…€ì—ì„œ ì •ìƒì ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.)`)) {
	    return;
	  }
	  
	  let csvData = tableToCSVWithSelection();
	  let dateStr = new Date().toISOString().slice(0, 10);
	  downloadCSV(csvData, `êµ¬ë§¤ì‹ ì²­ë¦¬ìŠ¤íŠ¸_${dateStr}.csv`);
	}


	// ìƒë‹´ ì·¨ì†Œ ê¸°ëŠ¥
	function handleCancel(btn, id, customerId, vehicleName) {
	  // 7ë²ˆì§¸ ì»¬ëŸ¼ì´ í¬ë§êµ¬ë§¤ì‹œì , 8ë²ˆì§¸ ì»¬ëŸ¼ì´ ìƒë‹´ìƒíƒœ
	  let statusCell = btn.closest('tr').cells[8]; 
	  let badge = statusCell.querySelector('.status-badge');

	  if (!badge) return;

	  let currentStatus = badge.textContent.trim();
	  if (currentStatus === 'ìƒë‹´ì·¨ì†Œ') return;

	  if (!confirm(`[${customerId} / ${vehicleName}] ìƒë‹´ì„ 'ìƒë‹´ì·¨ì†Œ' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
	    return;
	  }
	  
	  
	  // ì„ì‹œ í”„ë¡ íŠ¸ì—”ë“œ ì²˜ë¦¬
	  badge.textContent = 'ìƒë‹´ì·¨ì†Œ';
	  badge.className = 'badge bg-secondary status-badge';
	  btn.style.display = 'none';
	  alert('ìƒë‹´ ìƒíƒœê°€ ì·¨ì†Œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (í”„ë¡ íŠ¸ì—”ë“œ ì„ì‹œ ì²˜ë¦¬)');
	}

	// ìƒë‹´ ì‚­ì œ ê¸°ëŠ¥
	function handleDelete(row, id, customerId, vehicleName) {
	  if (!confirm(`[${customerId} / ${vehicleName}] ìƒë‹´ì„ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
	    return;
	  }
	  
	  // ì„ì‹œ í”„ë¡ íŠ¸ì—”ë“œ ì²˜ë¦¬
	  row.remove();
	  alert('ìƒë‹´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (í”„ë¡ íŠ¸ì—”ë“œ ì„ì‹œ ì²˜ë¦¬)');
	  // window.location.reload(); 
	}


    /* ====== ì´ë²¤íŠ¸ ì—°ê²° ====== */
    selectAllCheckbox.addEventListener('change', handleSelectAllChange);
    statusFilter.addEventListener('change', applyFiltersAndSorting);
    sortFilter.addEventListener('change', applyFiltersAndSorting);
    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') applyFiltersAndSorting();
    });
    btnExcelDownload.addEventListener('click', handleExcelDownload);
	
	// ì·¨ì†Œ/ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ (ì´ë²¤íŠ¸ ìœ„ì„)
	tableBody.addEventListener('click', handleActionClick);

    
  </script>
  <th:block th:replace="~{bottom}"></th:block>
</body>
</html>