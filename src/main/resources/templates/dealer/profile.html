<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìë™ì°¨ ë”œëŸ¬ CRM</title>
  <link th:href="@{/css/dealerProfile.css}" rel="stylesheet">
</head>
<body>
  <div class="sidebar">
    <div class="sidebar__logo">
      <div class="sidebar__logo-title">ê´€ë¦¬ ë©”ë‰´</div>
    </div>
    <div class="sidebar__section-title">Navigation</div>
    <ul class="menu-list">
	  <li>
	    <a th:href="@{/main}" class="menu-item">
	      <span class="menu-item__bullet"></span>
	      <span>ë©”ì¸ ëŒ€ì‹œë³´ë“œ</span>
	    </a>
	  </li>
      <li>
        <a th:href="@{/dealer}" class="menu-item menu-item--active">
          <span class="menu-item__bullet"></span>
          <span>ë”œëŸ¬ í”„ë¡œí•„</span>
        </a>
      </li>
      <li>
        <a th:href="@{/dealer/care}" class="menu-item">
          <span class="menu-item__bullet"></span>
          <span>ìƒë‹´ ì‹ ì²­ ëª…ë‹¨</span>
        </a>
      </li>
      <li>
        <a th:href="@{/dealer/myCustomer}" class="menu-item">
          <span class="menu-item__bullet"></span>
          <span>ìƒë‹´ ê´€ë¦¬</span>
        </a>
      </li>
      <li>
        <a th:href="@{/dealer/sale}" class="menu-item">
          <span class="menu-item__bullet"></span>
          <span>êµ¬ë§¤ ê´€ë¦¬</span>
        </a>
      </li>
    </ul>
    <div class="sidebar__bottom">
      HYUNDAI CRM Â· Dealer Console
    </div>
  </div>

  <div class="main">
    <div class="header">
      <div class="header__left">
        <div class="logo">HYUNDAI CRM</div>
        <div class="header__chip">Dealer Dashboard</div>
      </div>
      <div class="user-info">
        <span class="user-info__role">ë‹´ë‹¹ ë”œëŸ¬</span>
        <span>[[${#authentication.getPrincipal().getUsername()}]] ë‹˜</span>
        <span class="logout"><a sec:authorize="isAuthenticated()" th:href="@{/logout}" class="nav-link">ë¡œê·¸ì•„ì›ƒ</a></span>
      </div>
    </div>

    <div class="content">
      <div class="content__row">

        <!-- ë”œëŸ¬ íŒ¨ë„ -->
        <aside class="dealer-panel">
          <section class="card dealer-profile">
            <div class="card__header">
              <div>
                <h3 class="card__title">ë”œëŸ¬ ì •ë³´</h3>
                <p class="card__subtitle">ê¸°ë³¸ í”„ë¡œí•„ ë° ì—°ë½ì²˜</p>
              </div>
              <span class="card__chip">ì‹¤ì‹œê°„ ë™ê¸°í™”</span>
            </div>

            <div class="dealer-profile__top">
              <div class="dealer-avatar">
                <span>[[${#strings.substring(dealer.name,0,1)}]]</span>
              </div>
              <div>
                <div class="dealer-profile__name">[[${dealer.name}]]</div>
                <p class="dealer-profile__meta">
                  <strong>ì§ê¸‰</strong> [[${dealer.role}]]<br />
                  <strong>ê·¼ë¬´ì§€</strong> í˜„ëŒ€ìë™ì°¨ ì„œìš¸ì§€ì 
                </p>
              </div>
            </div>

            <div class="dealer-profile__divider"></div>

            <div class="dealer-contact">
              <div>
                <span class="dealer-contact__label">ì „í™”</span>
                <span>[[${dealer.phone}]]</span>
              </div>
              <div>
                <span class="dealer-contact__label">ì´ë©”ì¼</span>
                <span>[[${dealer.email}]]</span>
              </div>
            </div>

            <div class="dealer-status-row">
              <span class="dealer-status-tag">ì˜¨ë¼ì¸ â€¢ ìƒë‹´ ê°€ëŠ¥</span>
              <span class="dealer-status-text">ìµœê·¼ í™œë™: 5ë¶„ ì „</span>
            </div>
          </section>
		  
		    <section class="card notice-list-section" style="flex:1;">
		        <div class="card__header">
		          <h3 class="card__title">ê³µì§€ì‚¬í•­ ëª©ë¡</h3>
		          <span class="card__subtitle">ì´ [[${noticePage.totalElements}]]ê±´ì˜ ê³µì§€/ì•Œë¦¼ ë‚´ì—­ì…ë‹ˆë‹¤.</span>
		        </div>
		        
		      <div class="notice-list">
		        <div th:each="notice : ${notices}" class="notice-item" 
		          th:classappend="${notice.isImportant ? 'important-notice-item' : ''}"
		          th:style="${notice.isImportant ? 'border-left: 4px solid var(--warning);' : ''}"
		          >
		          <div class="notice-item__content">
		            <span class="notice-item__title" th:text="${notice.isImportant ? 'â­ ' + notice.title : notice.title}">ê³µì§€ì‚¬í•­ ì œëª©</span>
		            <span class="notice-item__meta">
		              ë“±ë¡ì¼: <span th:text="${notice.createDate}"></span> 
		              | ë“±ë¡ì: <span th:text="${notice.createName}">ê´€ë¦¬ì</span>
		            </span>
		          </div>
		          <span class="notice-item__target" 
		            th:text="${notice.target}"
		            th:style="${notice.isImportant ? 'background: #fef3c7; color: #b45309;' : ''}"
		            >ì „ì²´ ë”œëŸ¬</span>
		        </div>
		        <div th:if="${notices.isEmpty()}" style="text-align: center; color: var(--text-muted); padding: 20px;">
		           ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.
		        </div>
		      </div>
		        
		      <div th:if="${!noticePage.isEmpty()}" class="pagination-container" style="display: flex; justify-content: center; margin-top: 15px;">
		        <nav aria-label="Page navigation">
		          <ul class="pagination" style="list-style: none; display: flex; gap: 5px; padding: 0;">			                  
		  			<li th:class="${noticePage.first ? 'disabled' : ''}" style="display: inline-block;">
		                <a th:if="${!noticePage.first}" th:href="@{/admin/profile(page=${noticePage.number - 1})}" class="page-link" 
		                    style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 5px; color: #0d47a1; text-decoration: none; font-size: 13px;">
		                     ì´ì „
		                </a>
		                <span th:if="${noticePage.first}" class="page-link disabled"
		                    style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 5px; color: #6c757d; text-decoration: none; font-size: 13px; cursor: not-allowed;">
		                     ì´ì „
		                </span>
		              </li>	                  
		              <li th:each="i : ${#numbers.sequence(0, noticePage.totalPages - 1)}" 
		                th:class="${i == currentPage ? 'active' : ''}"
		                style="display: inline-block;">
		                <a th:if="${i == currentPage}" class="page-link active" 
		                   style="padding: 6px 10px; border: 1px solid #0d47a1; border-radius: 5px; background: #0d47a1; color: #fff; text-decoration: none; font-size: 13px; font-weight: bold;"
		                   th:text="${i + 1}"></a>
		                <a th:unless="${i == currentPage}" th:href="@{/admin/profile(page=${i})}" class="page-link" 
		                   style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 5px; color: #0d47a1; text-decoration: none; font-size: 13px;"
		                   th:text="${i + 1}"></a>
		              </li>
		              
		  		  <li th:class="${noticePage.last ? 'disabled' : ''}" style="display: inline-block;">
		                  <a th:if="${!noticePage.last}" th:href="@{/admin/profile(page=${noticePage.number + 1})}" class="page-link"
		                    style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 5px; color: #0d47a1; text-decoration: none; font-size: 13px;">
		                      ë‹¤ìŒ
		                  </a>
		                  <span th:if="${noticePage.last}" class="page-link disabled"
		                    style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 5px; color: #6c757d; text-decoration: none; font-size: 13px; cursor: not-allowed;">
		                      ë‹¤ìŒ
		                  </span>
		               </li>
		         </ul>
		        </nav>
		    </div>
		  </section>

          <section class="card">
            <div class="card__header">
              <h3 class="card__title">ë‚˜ì˜ KPI</h3>
              <span class="card__subtitle"></span>
            </div>
            <div class="kpi-box">
              <div class="kpi-item">
                <div class="kpi-item__label">ìƒë‹´ ì§„í–‰</div>
                <div class="kpi-item__value">[[${progressCnt}]]ê±´</div>
                <div class="kpi-item__trend"></div>
              </div>
			  <div class="kpi-item">
			    <div class="kpi-item__label">ìƒë‹´ ì™„ë£Œ</div>
			    <div class="kpi-item__value">[[${completCnt}]]ê±´</div>
			    <div class="kpi-item__trend kpi-item__trend--down"></div>
			  </div>
              <div class="kpi-item">
                <div class="kpi-item__label">íŒë§¤ ì™„ë£Œ</div>
                <div class="kpi-item__value">[[${saleCnt}]]ëŒ€</div>
                <div class="kpi-item__trend"></div>
              </div>
            </div>
          </section>

		  <section class="card monthly-card" style="flex:1.2;">
		    <div class="card__header">
		      <h3 class="card__title">ì›”ê°„ íŒë§¤ëŸ‰</h3>
		      <span class="card__subtitle">ì‹¤ì‹œê°„ ë”œëŸ¬ë³„ ì›”ë³„ ì‹¤ì </span>
		    </div>
		    
			<div style="height: 580px; overflow: hidden; background: #fafbfc; border-radius: 8px;">
				<iframe
				  th:src="@{|http://localhost:8506/5core?dealerId=${dealerId}|}"
				  style="width:100%;height:580px;border:none;"
				  scrolling="no">
				</iframe>
			</div>
		  
        </aside>

        <!-- ë©”ì¸ íŒ¨ë„ -->
        <section class="main-panel">
          <div class="main-panel__header-row">
            <div>
              <h2 class="page-title">ê³ ê° ëª…ë‹¨</h2>
              <p class="page-subtitle">ì‹¤ì‹œê°„ ìƒë‹´ì‹ ì²­ í˜„í™© ë° VIP ê³ ê° ê´€ë¦¬</p>
            </div>
          </div>

          <!-- ê³ ê° ë¦¬ìŠ¤íŠ¸ -->
          <section class="card customer-section">
            <div class="card__header">
              <h3 class="card__title">ê³ ê° ë¦¬ìŠ¤íŠ¸</h3>
              <div class="card__subtitle"></div>
            </div>
            <div class="customer-list-wrapper">
              <table class="customer-table">
                <thead>
                  <tr>
                    <th>ê³ ê°</th>
                    <th>ì „í™”ë²ˆí˜¸</th>
                    <th>ì´ë©”ì¼</th>
                    <th>ë“±ê¸‰</th>
                    <th>ìƒíƒœ</th>
                    <th>êµ¬ë§¤ íšŸìˆ˜</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="customer, customerStat : ${counselingList}" class="customer-row">
                    <td>
                      <div class="customer-name-cell">
                        <div class="customer-avatar">
                          <span th:text="${#strings.substring(customer.customer.member.name,0,1)}"></span>
                        </div>
                        <span th:text="${customer.customer.member.name}"></span>
                      </div>
                    </td>
                    <td th:text="${customer.customer.member.phone}"></td>
                    <td th:text="${customer.customer.member.email}"></td>
                    <td>
                      <span th:if="${customer.customer.segment == 'vip'}" class="badge badge--vip">VIP</span>
                      <span th:if="${customer.customer.segment == 'ì¼ë°˜'}" class="badge badge--lead">ì¼ë°˜</span>
                    </td>
                    <td>
                      <span class="badge badge--pending" >[[${customer.status}]]</span>
                      <!--<span class="badge badge--lead" >ì‹œìŠ¹ ì˜ˆì•½</span>
                      <span class="badge badge--vip" >êµ¬ë§¤ ì™„ë£Œ</span>-->
                    </td>
                    <td>
                      <span class="customer-tag" >[[${customer.customer.purchaseCount}]]</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- ì˜¤ëŠ˜ì˜ ì—…ë¬´ ìš”ì•½ + ì›”ê°„ íŒë§¤ -->
          <div class="content__row" style="gap:16px; align-items:stretch;">
			
			<!-- ë‹¬ë ¥ -->
			<section class="card" style="flex:1.5;">
			  <div class="card__header">
			    <h3 class="card__title">ìƒë‹´ ì¼ì •</h3>
			    <span class="card__subtitle">ìƒë‹´ì§„í–‰ì¤‘ â€¢ ìƒë‹´ì™„ë£Œ ê³ ê°</span>
			  </div>
			  
			  <div class="calendar-container">
			    <div class="calendar-header">
			      <div class="calendar-title" id="calendarTitle">2025ë…„ 12ì›”</div>
			      <div class="calendar-nav">
			        <button class="calendar-nav-btn" id="prevMonth">â€¹</button>
			        <button class="calendar-nav-btn" id="todayBtn">ì˜¤ëŠ˜</button>
			        <button class="calendar-nav-btn" id="nextMonth">â€º</button>
			      </div>
			    </div>
			    
			    <div class="calendar-grid" id="calendarGrid">
			      <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
			    </div>
			  </div>
			</section>

			<section class="card monthly-card" style="flex:1.2;">
			  <div class="card__header">
			    <h3 class="card__title">ì´ ì°¨ì¢…ë³„ íŒë§¤ëŸ‰</h3>
			    <span class="card__subtitle">ì°¨ì¢…ë³„ íŒë§¤ ì¶”ì´ (ì‹¤ì‹œê°„)</span>
			  </div>
			  
			  <!-- KPI+íŒŒì´ ì™„ë²½ fit -->
			  <div style="height: 615px; overflow: hidden; background: #fafbfc; border-radius: 8px; padding: 8px;">
			    <iframe
			        th:src="@{|http://localhost:8503/5core?dealerId=${dealerId}|}"
			        style="width: 100%; height: 100%; border: none;"
			        scrolling="no"
			        frameborder="0">
			    </iframe>
			  </div>
			</section>
			
			
          </div>
        </section>
      </div>
    </div>
  </div>
  
  <script th:inline="javascript">
      window.counselingScheduleData = /*[[${counselingSchedule}]]*/ [];
  </script>

  <script>
  class Calendar {
      constructor(data) {
          this.data = data || [];
          this.currentYear = new Date().getFullYear();
          this.currentMonth = new Date().getMonth();
          this.init();
      }
	  
	  dateToYMD(date) {
	      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate()); // ì‹œë¶„ì´ˆ 0ìœ¼ë¡œ
	      const y = d.getFullYear();
	      const m = (d.getMonth() + 1).toString().padStart(2, '0');
	      const day = d.getDate().toString().padStart(2, '0');
	      return `${y}-${m}-${day}`;  // "yyyy-MM-dd"
	  }

      init() {
          this.renderHeader();
          this.renderCalendar();
          this.attachEvents();
      }

      renderHeader() {
          const title = document.getElementById('calendarTitle');
          if (title) {
              const monthText = (this.currentMonth + 1).toString().padStart(2, '0');
              title.textContent = `${this.currentYear}ë…„ ${monthText}ì›”`;
          }
      }

      renderCalendar() {
          const grid = document.getElementById('calendarGrid');
          if (!grid) return;
          grid.innerHTML = '';

          // 1. ìš”ì¼ í—¤ë”
          ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
              const header = document.createElement('div');
              header.className = 'calendar-day-header';
              header.textContent = day;
              grid.appendChild(header);
          });

          // 2. í˜„ì¬ ë…„/ì›” ê¸°ì¤€ìœ¼ë¡œ ìº˜ë¦°ë” ì‹œì‘ì¼ ê³„ì‚° (í•´ë‹¹ ì›” 1ì¼ì´ í¬í•¨ëœ ì£¼ì˜ ì¼ìš”ì¼)
          const firstDayOfMonth = new Date(this.currentYear, this.currentMonth, 1);
          const startDate = new Date(firstDayOfMonth);
          startDate.setDate(firstDayOfMonth.getDate() - firstDayOfMonth.getDay());

          // 3. 6ì£¼(42ì¹¸) ì±„ìš°ê¸°
          for (let i = 0; i < 42; i++) {
              const date = new Date(startDate);
              date.setDate(startDate.getDate() + i);

              const dayCell = document.createElement('div');
              dayCell.className = 'calendar-day';

              // ë‹¤ë¥¸ ë‹¬ ë‚ ì§œëŠ” ì—°í•œ íšŒìƒ‰
              if (date.getMonth() !== this.currentMonth) {
                  dayCell.classList.add('other-month');
              }

              // ì˜¤ëŠ˜ ë‚ ì§œ íŒŒë€ìƒ‰
              if (this.isToday(date)) {
                  dayCell.classList.add('today');
              }

              dayCell.innerHTML = `
                  <div class="calendar-day-number">${date.getDate()}</div>
                  <div class="calendar-events">${this.getDayEvents(date)}</div>
              `;

              dayCell.onclick = () => this.showDayDetail(date);
              grid.appendChild(dayCell);
          }
      }

	  getDayEvents(date) {
	      const dayStr = this.dateToYMD(date);
	      const events = this.data.filter(item =>
	          item.counselingDate === dayStr &&
	          (item.status === 'ìƒë‹´ì§„í–‰ì¤‘' || item.status === 'ìƒë‹´ì™„ë£Œ')
	      );

	      if (events.length === 0) {
	          return '<div class="calendar-event empty">ìƒë‹´ì—†ìŒ</div>';
	      }

	      return events
	          .slice(0, 2)
	          .map(event => `
	              <div class="calendar-event ${event.status === 'ìƒë‹´ì™„ë£Œ' ? 'completed' : 'progress'}">
	                  ${event.customerName}
	              </div>
	          `).join('') +
	          (events.length > 2 ? `<div class="calendar-event">+${events.length - 2}</div>` : '');
	  }

      isToday(date) {
          const today = new Date();
          return date.toDateString() === today.toDateString();
      }

	  showDayDetail(date) {
	      const dayStr = this.dateToYMD(date);
	      const events = this.data.filter(item =>
	          item.counselingDate === dayStr &&
	          (item.status === 'ìƒë‹´ì§„í–‰ì¤‘' || item.status === 'ìƒë‹´ì™„ë£Œ')
	      );

	      if (events.length === 0) {
	          alert(`${date.toLocaleDateString('ko-KR')} ìƒë‹´ì—†ìŒ`);
	          return;
	      }

	      const details = events.map(e =>
	          `ğŸ‘¤ ${e.customerName} (${e.phone})\nìƒíƒœ: ${e.status}`
	      ).join('\n\n');
	      alert(`ğŸ“… ${date.toLocaleDateString('ko-KR')} (${events.length}ê±´)\n\n${details}`);
	  }

      prevMonth() {
          this.currentMonth--;
          if (this.currentMonth < 0) {
              this.currentMonth = 11;
              this.currentYear--;
          }
          this.render();
      }

      nextMonth() {
          this.currentMonth++;
          if (this.currentMonth > 11) {
              this.currentMonth = 0;
              this.currentYear++;
          }
          this.render();
      }

      goToday() {
          const today = new Date();
          this.currentYear = today.getFullYear();
          this.currentMonth = today.getMonth();
          this.render();
      }

      render() {
          this.renderHeader();
          this.renderCalendar();
      }

      attachEvents() {
          const prevBtn = document.getElementById('prevMonth');
          const nextBtn = document.getElementById('nextMonth');
          const todayBtn = document.getElementById('todayBtn');

          if (prevBtn) prevBtn.onclick = () => this.prevMonth();
          if (nextBtn) nextBtn.onclick = () => this.nextMonth();
          if (todayBtn) todayBtn.onclick = () => this.goToday();
      }
  }

  // ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', function() {
      let data = window.counselingScheduleData || [];
      data = data.filter(item =>
          item && item.counselingDate &&
          (item.status === 'ìƒë‹´ì§„í–‰ì¤‘' || item.status === 'ìƒë‹´ì™„ë£Œ')
      );
      new Calendar(data);
  });
  </script>



</body>

</html>